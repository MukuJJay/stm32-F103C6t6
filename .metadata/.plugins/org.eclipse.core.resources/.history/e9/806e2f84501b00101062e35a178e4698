#include <stdint.h>
#include "led.h"

void delay(uint32_t count)
{
    for (uint32_t i = 0; i < count; i++);
}

void led_init_all(void)
{
    /* Enable clock for GPIOD (AHB1ENR bit 3) */
    volatile uint32_t *pRccAhb1enr   = (uint32_t *)0x40023830;
    volatile uint32_t *pGpiodModeReg = (uint32_t *)0x40020C00;

    *pRccAhb1enr |= (1U << 3);

    /* Configure PD12 (LED_GREEN), PD13 (LED_ORANGE), PD14 (LED_RED), PD15 (LED_BLUE) as outputs */
    *pGpiodModeReg &= ~((0x3U << (2 * LED_GREEN))  \
                      | (0x3U << (2 * LED_ORANGE)) \
                      | (0x3U << (2 * LED_RED))    \
                      | (0x3U << (2 * LED_BLUE)));

    *pGpiodModeReg |=  ((1U << (2 * LED_GREEN))  \
                      | (1U << (2 * LED_ORANGE)) \
                      | (1U << (2 * LED_RED))    \
                      | (1U << (2 * LED_BLUE)));

#if 0
    /* Optionally configure output type (OTYPER) to push-pull if needed */
    volatile uint32_t *pGpioOpTypeReg = (uint32_t *)0x40020C04;
    *pGpioOpTypeReg &= ~((1U << LED_GREEN)
                        | (1U << LED_ORANGE)
                        | (1U << LED_RED)
                        | (1U << LED_BLUE));
#endif

    /* Ensure all LEDs are off at startup */
    led_off(LED_GREEN);
    led_off(LED_ORANGE);
    led_off(LED_RED);
    led_off(LED_BLUE);
}

void led_on(uint8_t led_no)
{
    volatile uint32_t *pGpiodDataReg = (uint32_t *)0x40020C14;
    *pGpiodDataReg |= (1U << led_no);
}

void led_off(uint8_t led_no)
{
    volatile uint32_t *pGpiodDataReg = (uint32_t *)0x40020C14;
    *pGpiodDataReg &= ~(1U << led_no);
}
